@model  CallCenter.Models.TicketManagementModel

@{
    ViewBag.Title = "Ticket List";
}
<link href="~/Content/jquery-ui.css" rel="stylesheet" />
@*<script src="~/Scripts/jquery-3.3.1.min.js"></script>
    <script src="~/Scripts/jquery-ui.js"></script>*@

<h2>Ticket Management</h2>
@using (Html.BeginForm())
{

<div class="row padingtop-bottom20px">
    <div class="row">
        <div class="col-md-2">
            @Html.EditorFor(model => model.TicketOpenDate, new { htmlAttributes = new { @class = "form-control", placeholder = "From date" } })
            @Html.ValidationMessageFor(model => model.TicketOpenDate, "", new { @class = "text-danger" })
        </div>
        <div class="col-md-2">
            @Html.EditorFor(model => model.TicketCloseDate, new { htmlAttributes = new { @class = "form-control", placeholder = "To date" } })
            @Html.ValidationMessageFor(model => model.TicketCloseDate, "", new { @class = "text-danger" })
        </div>

        <div class="col-md-2">
            @Html.EditorFor(model => model.CallingNumber, new { htmlAttributes = new { @class = "form-control", placeholder = "Enter calling number" } })
        </div>
        <div class="col-md-2">
            @Html.EditorFor(model => model.Name, new { htmlAttributes = new { @class = "form-control", placeholder = "Enter customer name" } })
        </div>
        <div class="col-md-2">
            @Html.EditorFor(model => model.PolicyNumber, new { htmlAttributes = new { @class = "form-control", placeholder = "Enter policy number" } })
        </div>
    </div>
    <div class="row" style="margin-top:10px;">
        <div class="col-md-2">
            @Html.DropDownListFor(model => model.Status, new SelectList(new[] {new SelectListItem { Text = "Select Status", Value = "Select Status" },
                                                                                new SelectListItem { Text = "Open", Value = "Open" },
                                                                                 new SelectListItem { Text = "InProgress", Value = "InProgress" },
                                                                                 new SelectListItem { Text = "Closed", Value = "Closed" }
                                                                            }, "Text", "Value"), new { @class = "form-control" })
        </div>
        <div class="col-md-2">
            <input type="submit" value="Apply" class="btn btn-primary" />
        </div>
        <div class="col-md-8">
            <input type="button" id="btnDownladExcel" class="btn btn-primary" value="Download Excel" onclick="exportToExcel('testTable', 'Excel Export')" style="float:right" />
            @*<input type="button" id="btnDownladExcel" class="btn btn-primary" value="Download Excel" style="float:right" />*@
            <input type="button" name="btnCreateTicket" class="btn btn-primary" value="Create Ticket" style="float:right;margin-right:10px;" onclick="window.location= '@Url.Action("TicketManagement", "Home")'" />
        </div>
    </div>
</div>
}
<table class="table" id="testTable">
    <tr>
        <th>
            @Html.DisplayName("Ticket ID")
        </th>
        <th>
            @Html.DisplayName("Name")
        </th>
        <th>
            @Html.DisplayName("Calling Number")
        </th>
        <th>
            @Html.DisplayName("Type Of Caller")
        </th>
        <th>
            @Html.DisplayName("Client Type")
        </th>
        <th>
            @Html.DisplayName("Policy Number")
        </th>
        <th>
            @Html.DisplayName("Segment")
        </th>
        <th>
            @Html.DisplayName("Type Of Call")
        </th>

        <th>
            @Html.DisplayName("Category")
        </th>
        <th>
            @Html.DisplayName("Sub Category")
        </th>
        <th>
            @Html.DisplayName("Sub Sub Category")
        </th>
        <th>
            @Html.DisplayName("Remark")
        </th>
        <th>
            @Html.DisplayName("Status")
        </th>
        <th>
            @Html.DisplayName("Ticket Open Date")
        </th>
        <th>
            @Html.DisplayName("Ticket Close Date")
        </th>
        <th>
            @Html.DisplayName("Ticket Open Agent")
        </th>
        <th>
            @Html.DisplayName("Action by")
        </th>
        <th>
            @Html.DisplayName("Duration (Minutes)")
        </th>
        <th>

        </th>
    </tr>

    @foreach (var item in Model.TicketList.OrderByDescending(d=>d.TicketOpenDate))
    {
<tr>
    <td>
        @Html.DisplayFor(modelItem => item.TicketId)
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.Name)
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.CallingNumber)
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.TypeOfCaller)
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.ClientType)
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.PolicyNumber)
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.CustomerSegment)
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.TypeOfCall)
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.Category)
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.SubCategory)
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.SubSubCategory)
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.Remark)
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.Status)
    </td>
    <td>
        @if (item.TicketOpenDate != null)
        {
            @Html.DisplayFor(modelItem => item.TicketOpenDate)
        }
    </td>
    <td>
        @if (item.TicketCloseDate != null)
        {
            @Html.DisplayFor(modelItem => item.TicketCloseDate)
        }
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.TicketOpenAgentName)
    </td>
    <td>
        @Html.DisplayFor(modelItem => item.TicketCloseAgentName)
    </td>

    <td>
        @Html.DisplayFor(modelItem => item.Duration)
    </td>

    <td>
        @if ((item.Status == null) || (item.Status.ToLower() != "closed"))
        {
            if (ViewBag.IsAccess == true)
            {
                @Html.ActionLink("Edit", "TicketManagementEdit", new { id = item.TicketId })
            }

        }
    </td>



</tr>
    }

</table>
<style>
    .btn {
        padding: 5px 8px;
    }
</style>
@section Scripts {
    <script src="~/Scripts/jquery-ui.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {

            //if ($("#TicketOpenDate").val() == '01-01-1900 12.00.00 AM')
            //    $("#TicketOpenDate").val("");

            //if ($("#TicketCloseDate").val() == '01-01-1900 12.00.00 AM')
            //    $("#TicketCloseDate").val("");

            $('input[type=datetime]').datepicker({
                dateFormat: "dd/mm/yy",
                setDate: new Date(),
                changeMonth: true,
                changeYear: true
            });


           /* $("#btnDownladExcel").click(function () {
                $.ajax(
                    {
                        url: '/Home/TicketDownloadExcel?opendate=' + $("#TicketOpenDate").val() + '&closedate=' + $("#TicketCloseDate").val() + '&callingno=' + $("#CallingNumber").val()+'&status='+$("#Status").val(),
                        type: 'GET',
                        data: "",
                        contentType: 'application/json; charset=utf-8',
                        success: function (data) {
                            var blob = new Blob([data], { type: 'application/ms-excel' });
                            var downloadUrl = URL.createObjectURL(blob);
                            var a = document.createElement("a");
                            a.href = downloadUrl;
                            a.download = "TicketListExcel.xls";
                            document.body.appendChild(a);
                            a.click();
                        },
                        error: function () {
                            alert("error");
                        }
                    });

            });*/

        });

          function exportToExcel (table, name) {
                            var uri = 'data:application/vnd.ms-excel;base64,'
                                ,template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
                                , base64 = function (s) {
                                    return window.btoa(unescape(encodeURIComponent(s)))
                                }
                                , format = function (s, c) {
                                    return s.replace(/{(\w+)}/g, function (m, p) {
                                        return c[p];
                                    })
                                }
                            if (!table.nodeType) table = document.getElementById(table)
                            var ctx = {worksheet: name || 'Worksheet', table: table.innerHTML}
                            var a = document.createElement('a');
                            a.href = uri + base64(format(template, ctx))
                            a.download = 'ticketlist.xls';
                            //triggering the function
                            a.click();
                        }

    </script>
}


@*<script type="text/javascript">
        $(document).ready(function () {
            $("#TicketOpenDate").datepicker({
                dateFormat: "dd/M/yy",
                changeMonth: true,
                changeYear: true,
                yearRange: "-60:+0"
            });
        });

    </script>*@
